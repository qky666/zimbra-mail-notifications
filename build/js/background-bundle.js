!function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={exports:{},id:r,loaded:!1};return e[r].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}var o=n(8),i=r(o);i["default"].configurarListeners()},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(2),u=r(a),s=n(5),c=r(s),l=n(12),f=r(l),d=function(){function e(){return o(this,e),null}return i(e,null,[{key:"getServidor",value:function(e){var t=this;c["default"].getOpciones(function(n){return u["default"].log("Gestor Servidor. Get Servidor. Voy a mirar si existe servidor previo"),t._servidor&&(u["default"].log("Gestor Servidor. Get Servidor. Sí existe servidor previo: _this._servidor.urlAsString="+t._servidor.urlAsString+". opciones.urlZimbra="+n.urlZimbra),t._servidor.urlAsString==n.urlZimbra)?(u["default"].log("Gestor Servidor. Get Servidor. Existe servidor previo y la URL es la buena"),void e(t._servidor)):(u["default"].log("Gestor Servidor. Get Servidor. Estoy creando un nuevo servidor"),t._servidor=new f["default"](n.urlZimbra),void t._servidor.init(function(){e(t._servidor)}))})}}]),e}();t["default"]=d},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(3),u=r(a),s=function(){function e(){o(this,e)}return i(e,[{key:"constrctor",value:function(){return null}}],[{key:"log",value:function(e){if(u["default"].logs){var t=new Date;console.log(t+". "+e)}}},{key:"error",value:function(e){var t=new Date;console.error(t+". "+e)}}]),e}();t["default"]=s},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=!1,r=!0,o="IdAlarmaCorreoZimbra",i="IdNotificacionCorreoZimbra",a="",u=1,s=!0,c=!1;t["default"]={periodoOverride:n,logs:r,ID_ALARMA_CORREO:o,ID_NOTIF_CORREO:i,urlZimbraDefecto:a,minutosIntervaloDefecto:u,mostrarNotificacionesDefecto:s,notificacionesPermanentesDefecto:c}},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(1),u=r(a),s=n(2),c=r(s),l=function(){function e(){return o(this,e),null}return i(e,null,[{key:"borrarMensajesOcultos",value:function(e){c["default"].log("Gestor Mensajes. Borrar Mensajes Ocultos. Inicio"),chrome.storage.local.remove(["mensajesOcultos"],e)}},{key:"_setIdsMensajesOcultos",value:function(e,t){return Array.isArray(e)?(chrome.storage.local.set({mensajesOcultos:e},t),void c["default"].log("Gestor Mensajes. _Set Ids Mensajes Ocultos. Grabados: "+JSON.stringify(e))):void c["default"].error("Hemos intentado grabar mensajes ocultos incorrectos")}},{key:"_getIdsMensajesOcultos",value:function(e){chrome.storage.local.get("mensajesOcultos",function(t){var n=[];t.mensajesOcultos&&Array.isArray(t.mensajesOcultos)&&(c["default"].log("Gestor Mensajes. _Get Ids Mensajes Ocultos. La lectura ha sido buena!"),n=t.mensajesOcultos),c["default"].log("Gestor Mensajes. _Get Ids Mensajes Ocultos. Leídos: "+JSON.stringify(n)),e(n)})}},{key:"_getMensajesOcultos",value:function(t){u["default"].getServidor(function(n){e._getIdsMensajesOcultos(function(e){for(var r=[],o=0;o<e.length;o++){var i=n.mensajeConId(e[o]);i&&r.push(i)}c["default"].log("Gestor Mensajes. _Get Mensajes Ocultos. mensajesOcultos obtenidos: "+JSON.stringify(r)),t(r)})})}},{key:"_setMensajesOcultos",value:function(t,n){function r(e){return e.id}if(!t.length)return c["default"].log("Gestor Mensajes. _Set Mensajes Ocultos. Voy a llamar a Borrar Mensajes Ocultos"),void e.borrarMensajesOcultos(n);var o=t.map(r);e._setIdsMensajesOcultos(o,n)}},{key:"_sanearMensajesOcultos",value:function(t){u["default"].getServidor(function(n){return n.error?void t():void e._getMensajesOcultos(function(r){function o(e){var t=n.mensajes.map(function(e){return e.id});return!(t.indexOf(e.id)<0)}c["default"].log("Gestor Mensajes. _Sanear Mensajes Ocultos. Voy a llamar a _Set Mensajes Ocultos con: "+JSON.stringify(r.filter(o))),e._setMensajesOcultos(r.filter(o),t)})})}},{key:"addMensajeOculto",value:function(t,n){var r=t;t instanceof Mensaje&&(r=[t]),e._getMensajesOcultos(function(t){for(var o=t,i=t.map(function(e){return e.id}),a=0;a<r.length;a++)i.indexOf(r[a].id)<0&&o.push(r[a]);c["default"].log("Gestor Mensajes. Add Mensaje Oculto. Voy a llamar a _Set Mensajes Ocultos con: "+JSON.stringify(o)),e._setMensajesOcultos(o,function(){e._sanearMensajesOcultos(n)})})}},{key:"getMensajes",value:function(t){u["default"].getServidor(function(n){e._getMensajesOcultos(function(e){function r(t){return e.indexOf(t)<0}var o=n.mensajes?n.mensajes.filter(r):[];t({mensajesNoOcultos:o,mensajesOcultos:e})})})}}]),e}();t["default"]=l},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(3),s=r(u),c=n(2),l=r(c),f=function(){function e(){return o(this,e),null}return a(e,null,[{key:"borrarOpciones",value:function(e){chrome.storage.local.remove(["opciones"],e)}},{key:"setOpciones",value:function(e,t){("object"!=("undefined"==typeof e?"undefined":i(e))||Array.isArray(e))&&l["default"].error("Hemos intentado grabas unas opciones incorrectas"),chrome.storage.local.set({opciones:e},t)}},{key:"getOpciones",value:function(e){chrome.storage.local.get({opciones:{urlZimbra:s["default"].urlZimbraDefecto,minutosIntervalo:s["default"].minutosIntervaloDefecto,mostrarNotificaciones:s["default"].mostrarNotificacionesDefecto,notificacionesPermanentes:s["default"].notificacionesPermanentesDefecto}},function(t){l["default"].log("OpcionesStorage. Get Opciones. Leído: items="+JSON.stringify(t));var n=t.opciones;("object"!=("undefined"==typeof n?"undefined":i(n))||Array.isArray(n))&&(n={}),null==n.urlZimbra&&(n.urlZimbra=s["default"].urlZimbraDefecto),null==n.minutosIntervalo&&(n.minutosIntervalo=s["default"].minutosIntervaloDefecto),null==n.mostrarNotificaciones&&(n.mostrarNotificaciones=s["default"].mostrarNotificacionesDefecto),null==n.notificacionesPermanentes&&(n.notificacionesPermanentes=s["default"].notificacionesPermanentesDefecto),e(n)})}}]),e}();t["default"]=f},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){return n(this,e),null}return r(e,null,[{key:"getBrowserActionPopupSiAbiero",value:function(){for(var e=chrome.extension.getViews({type:"popup"}),t=null,n=0;n<e.length;n++)e[n].document.title==chrome.i18n.getMessage("ba_default_title")&&(t=e[n]);return t}}]),e}();t["default"]=o},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(1),u=r(a),s=function(){function e(){return o(this,e),null}return i(e,null,[{key:"_tabsConZimbraAbierto",value:function(e){u["default"].getServidor(function(t){if(t.urlError)return void e([]);var n=t.urlAsURL;chrome.tabs.query({status:"complete",url:"*://"+n.host+"/*"},function(t){e(t)})})}},{key:"abrirOActivarZimbra",value:function(){u["default"].getServidor(function(t){if(!t.urlError){var n=t.urlAsURL;e._tabsConZimbraAbierto(function(e){if(e.length)chrome.windows.update(e[0].windowId,{focused:!0}),chrome.tabs.update(e[0].id,{active:!0});else{if(!n)return;chrome.tabs.create({active:!0,url:n.toString()})}})}})}},{key:"zimbraActivo",value:function(e){u["default"].getServidor(function(t){if(t.urlError)return void e(!1);var n=t.urlAsURL;chrome.windows.getLastFocused({populate:!0},function(t){if(t.focused===!1)return void e(!1);var r=["normal","maximized","fullscreen"];return r.indexOf(t.state)<0?void e(!1):void chrome.tabs.query({active:!0,highlighted:!0,lastFocusedWindow:!0,status:"complete",url:"*://"+n.host+"/*"},function(t){return t.length?void e(!0):void e(!1)})})})}}]),e}();t["default"]=s},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(3),u=r(a),s=n(9),c=r(s),l=n(10),f=r(l),d=n(4),m=r(d),v=n(11),g=r(v),b=n(1),h=r(b),y=n(2),O=r(y),p=n(6),_=r(p),j=n(7),M=r(j),A=function(){function e(){o(this,e)}return i(e,null,[{key:"configurarListeners",value:function(){chrome&&chrome.runtime&&chrome.runtime.onInstalled&&chrome.runtime.onInstalled.addListener&&chrome.runtime.onInstalled.addListener(function(t){e.runtimeOnInstalledListener(t)}),chrome.notifications.onClicked.addListener(function(t){e.notificationsOnClickedListener(t)}),chrome&&chrome.notifications&&chrome.notifications.onButtonClicked&&chrome.notifications.onButtonClicked.addListener&&chrome.notifications.onButtonClicked.addListener(function(t,n){e.notificationsOnButtonClickedListener(t,n)}),chrome.notifications.onClosed.addListener(function(t,n){e.notificationsOnClosedListener(t,n)}),chrome.alarms.onAlarm.addListener(function(t){e.alarmsOnAlarmListener(t)}),chrome.tabs.onActivated.addListener(function(t){e.tabsOnActivatedListener(t)}),chrome.windows.onFocusChanged.addListener(function(t){e.windowsOnFocusChangedListener(t)}),chrome.browserAction.onClicked.addListener(function(t){e.browserActionOnClickedListener(t)}),chrome.storage.onChanged.addListener(function(t,n){e.storageOnChangedListener(t,n)}),e.escucharWebNavigationOnCompleted()}},{key:"actualizarMensajes",value:function(t,n){h["default"].getServidor(function(r){r.actualizarMensajesNoleidos(function(){e.actualizarUis(t),n()})})}},{key:"actualizarUis",value:function(e){e.notificacion&&g["default"].notificarMensajes(),f["default"].establecerDistintivoEnBoton();var t=_["default"].getBrowserActionPopupSiAbiero();t&&t.actualizarDatos()}},{key:"abrirOActivarZimbraYLimpiarNotificacion",value:function(){M["default"].abrirOActivarZimbra(),g["default"].limpiarNotificacion(function(e){})}},{key:"siZimbraActivoLimpiarNotificacion",value:function(){g["default"].hayNotificacionActiva(function(e){e===!0&&M["default"].zimbraActivo(function(e){e&&g["default"].limpiarNotificacion(function(e){})})})}},{key:"runtimeOnInstalledListener",value:function(e){O["default"].log("CoordinadorZimbra. Runtime On Installed Listener. Inicio"),chrome.runtime.openOptionsPage(function(){}),c["default"].establecerAlarma()}},{key:"notificationsOnButtonClickedListener",value:function(t,n){O["default"].log("CoordinadorZimbra. Notifications On Button Clicked Listener. Inicio"),t==u["default"].ID_NOTIF_CORREO&&0==n&&(g["default"].limpiarNotificacion(function(e){}),c["default"].establecerAlarma(),m["default"].getMensajes(function(t){O["default"].log("CoordinadorZimbra. callback de Get Mensajes. Vamos a añadir mensajes ocultos: "+JSON.stringify(t.mensajesNoOcultos)),m["default"].addMensajeOculto(t.mensajesNoOcultos,function(){e.actualizarMensajes({notificacion:!1},function(){})})}))}},{key:"notificationsOnClickedListener",value:function(t){O["default"].log("CoordinadorZimbra. Notifications On Clicked Listener. Inicio"),t==u["default"].ID_NOTIF_CORREO&&(e.abrirOActivarZimbraYLimpiarNotificacion(),c["default"].establecerAlarma())}},{key:"notificationsOnClosedListener",value:function(e,t){O["default"].log("CoordinadorZimbra. Notifications On Closed Listener. Inicio"),e==u["default"].ID_NOTIF_CORREO&&t&&c["default"].establecerAlarma()}},{key:"alarmsOnAlarmListener",value:function(t){O["default"].log("CoordinadorZimbra. Alarms On Alarm Listener. Inicio"),t&&t.name==u["default"].ID_ALARMA_CORREO&&(O["default"].log("CoordinadorZimbra. Alarms On Alarm Listener. alarm.name="+t.name),e.actualizarMensajes({notificacion:!0},function(){}))}},{key:"tabsOnActivatedListener",value:function(t){O["default"].log("CoordinadorZimbra. Tabs On Activated Listener. Inicio"),e.siZimbraActivoLimpiarNotificacion()}},{key:"webNavigationOnCompletedListener",value:function(){O["default"].log("CoordinadorZimbra. Web Navigation On Completed Listener. Inicio"),e.siZimbraActivoLimpiarNotificacion()}},{key:"windowsOnFocusChangedListener",value:function(t){O["default"].log("CoordinadorZimbra. Windows On Focus Changed Listener. Inicio"),e.siZimbraActivoLimpiarNotificacion()}},{key:"browserActionOnClickedListener",value:function(t){g["default"].limpiarNotificacion(function(e){}),e.actualizarMensajes({notificacion:!1},function(){})}},{key:"storageOnChangedListener",value:function(t,n){t.hasOwnProperty("opciones")&&(c["default"].establecerAlarma(),e.escucharWebNavigationOnCompleted(),e.actualizarMensajes({notificacion:!0},function(){}))}},{key:"escucharWebNavigationOnCompleted",value:function(){var t=function(){e.webNavigationOnCompletedListener()};chrome.webNavigation.onCompleted.removeListener(t),h["default"].getServidor(function(e){if(!e.urlError){var n=e.urlAsURL;chrome.webNavigation.onCompleted.addListener(t,{url:[{hostEquals:n.host}]})}})}},{key:"onLoadBrowserAction",value:function(t){O["default"].log("CoordinadorZimbra. On Load Browser Action. Inicio"),g["default"].limpiarNotificacion(function(e){}),e.actualizarMensajes({notificacion:!1},t)}},{key:"onClickMensaje",value:function(){var t=_["default"].getBrowserActionPopupSiAbiero();t&&t.close(),e.abrirOActivarZimbraYLimpiarNotificacion(),c["default"].establecerAlarma()}},{key:"onMostrarOcultos",value:function(){m["default"].borrarMensajesOcultos(function(){e.actualizarMensajes({notificacion:!1},function(){})})}},{key:"getDatos",value:function(e){h["default"].getServidor(function(t){m["default"].getMensajes(function(n){e({mensajesNoLeidos:{noOcultos:n.mensajesNoOcultos,ocultos:n.mensajesOcultos},estado:t.estado})})})}}]),e}();t["default"]=A},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(3),u=r(a),s=n(1),c=r(s),l=n(5),f=r(l),d=function(){function e(){return o(this,e),null}return i(e,null,[{key:"establecerAlarma",value:function(){c["default"].getServidor(function(e){return""==e.urlAsString?void chrome.alarms.clear(u["default"].constantes.ID_ALARMA_CORREO,function(e){}):void f["default"].getOpciones(function(e){var t=e.minutosIntervalo;u["default"].periodoOverride&&(t=u["default"].periodoOverride),chrome.alarms.create(u["default"].constantes.ID_ALARMA_CORREO,{delayInMinutes:t,periodInMinutes:t})})})}}]),e}();t["default"]=d},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(4),u=r(a),s=n(1),c=r(s),l=function(){function e(){return o(this,e),null}return i(e,null,[{key:"establecerDistintivoEnBoton",value:function(){c["default"].getServidor(function(e){e.error?(chrome.browserAction.setBadgeBackgroundColor({color:[240,0,0,255]}),chrome.browserAction.setBadgeText({text:"X"})):u["default"].getMensajes(function(e){var t=e.mensajesNoOcultos.length;chrome.browserAction.setBadgeText({text:t.toString()}),0==t?chrome.browserAction.setBadgeBackgroundColor({color:[0,0,220,255]}):chrome.browserAction.setBadgeBackgroundColor({color:[0,190,0,255]})})})}}]),e}();t["default"]=l},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(3),u=r(a),s=n(4),c=r(s),l=n(1),f=r(l),d=n(5),m=r(d),v=n(13),g=r(v),b=n(6),h=r(b),y=n(7),O=r(y),p=function(){function e(){return o(this,e),null}return i(e,null,[{key:"limpiarNotificacion",value:function(e){chrome.notifications.clear(u["default"].ID_NOTIF_CORREO,e)}},{key:"notificarMensajes",value:function(){f["default"].getServidor(function(e){""!=e.urlAsString&&(h["default"].getBrowserActionPopupSiAbiero()||m["default"].getOpciones(function(t){t.mostrarNotificaciones&&O["default"].zimbraActivo(function(n){if(!n){if(e.error){var r="img/48_mail_error.png",o=chrome.i18n.getMessage("notif_zimbra_mail_error"),i={type:"basic",title:o,iconUrl:r,message:e.error,requireInteraction:t.notificacionesPermanentes};return g["default"].navegadorEsFirefox()&&(i={type:"basic",title:o,iconUrl:r,message:e.error}),void chrome.notifications.create(u["default"].ID_NOTIF_CORREO,i,function(e){})}c["default"].getMensajes(function(e){for(var n=[],r=0;r<e.mensajesNoOcultos.length;r++){var o=e.mensajesNoOcultos[r];n.push({title:o.de,message:o.titulo})}if(n.length>0){var i="img/48.png",a=chrome.i18n.getMessage("notif_zimbra_mail")+". "+chrome.i18n.getMessage("new_mail_notification_message",n.length.toString()),s="Zimbra Mail. "+chrome.i18n.getMessage("new_mail_notification_message",n.length.toString()),c={type:"list",title:a,iconUrl:i,message:s,items:n,requireInteraction:t.notificacionesPermanentes,buttons:[{title:chrome.i18n.getMessage("notif_do_not_show_again_for_these_messages")}]};g["default"].navegadorEsFirefox()&&(c={type:"basic",title:a,iconUrl:i,message:n.map(function(e){return e.title+": "+e.message}).join("\n")}),chrome.notifications.create(u["default"].ID_NOTIF_CORREO,c,function(e){})}})}})}))})}},{key:"hayNotificacionActiva",value:function(e){chrome.notifications.getAll(function(t){return t&&t[u["default"].ID_NOTIF_CORREO]?void e(!0):void e(!1)})}}]),e}();t["default"]=p},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(2),u=r(a),s=function(){function e(t){o(this,e),this._urlAsString=t,this._mensajes=[],this._estadoCarga={error:"¡No inicializado!"},this._ultimaConsulta=null}return i(e,[{key:"init",value:function(e){this.actualizarMensajesNoleidos(e)}},{key:"usarCache",value:function(){if(this.error)return!1;var e=new Date;return!!(this._ultimaConsulta&&e.getTime()-this._ultimaConsulta.getTime()<2e3)}},{key:"actualizarMensajesNoleidos",value:function(e){if(this.urlError)return this._mensajes=null,this._estadoCarga={error:this.urlError},void e();if(this.usarCache())return void e();var t=this.urlAsURL,n={query:"is:unread"},r=t.protocol+"//"+t.host+"/home/~/inbox.json",o=UtilesURL.codificarQueryURL(r,n),i=this,a=function(){i._ultimaConsulta=new Date,e()};this._estadoCarga={cargando:!0},window.fetch?this._actualizarNoLeidosFetch(o,a):this._actualizarNoLeidosXHR(o,a)}},{key:"_actualizarNoLeidosXHR",value:function(e,t){u["default"].log("GestorZimbra. Actualizar No Leidos XHR. Inicio");var n=this,r=new XMLHttpRequest;r.open("GET",e,!0),r.timeout=4e3,r.withCredentials=!0,r.onload=function(){return 200!=this.status?(n._establecerErrorRequest(this.statusText),void t()):(n._jsonAMensajes(this.responseText),void t())},r.onerror=function(e){n._establecerErrorRequest(this.statusText),t()},r.send()}},{key:"_actualizarNoLeidosFetch",value:function(e,t){u["default"].log("GestorZimbra. Actualizar No Leidos Fetch. Inicio");var n=this;window.fetch(e,{credentials:"include",method:"GET",headers:(new Headers).append("Content-Type","text/plain"),mode:"cors",cache:"default"}).then(function(e){return e&&e.ok?e.text():(e&&e.statusText?n._establecerErrorRequest(e.statusText):n._establecerErrorRequest(null),t(),Promise.reject(new Error("Response no ok")))},function(e){return e&&e.message?n._establecerErrorRequest(e.message):n._establecerErrorRequest(null),t(),Promise.reject(new Error("Promise rechazada"))}).then(function(e){n._jsonAMensajes(e),t()})}},{key:"_establecerErrorRequest",value:function(e){var t=void 0;t=e?e:chrome.i18n.getMessage("error_generico"),this._estadoCarga={error:t},this._mensajes=null}},{key:"_jsonAMensajes",value:function(e){var t=e.replace(/\\x/g,"\\u00"),n=JSON.parse(t),r=[];if(n.m)for(var o=0;o<n.m.length;o++){var i=n.m[o],a=new Mensaje(i);r.push(a)}this._estadoCarga={ok:!0},this._mensajes=r}},{key:"mensajeConId",value:function(e){function t(t){return t.id==e}var n=null,r=this.mensajes.filter(t);return r.length?(n=r[0],u["default"].log("Servidor Zimbra. Mensaje Con Id. He encontrado el mensaje: "+JSON.stringify(n))):u["default"].log("Servidor Zimbra. Mensaje Con Id. No he encontrado el mensaje con id: "+e),n}},{key:"urlAsString",get:function(){return this._urlAsString}},{key:"mensajes",get:function(){return this._mensajes}},{key:"urlAsURL",get:function(){var e=UtilesURL.stringToURL(this._urlAsString);return e.hasOwnProperty("error")?null:e.url}},{key:"urlError",get:function(){var e=UtilesURL.stringToURL(this._urlAsString);return e.hasOwnProperty("error")?e.error:null}},{key:"error",get:function(){return this.urlError?this.urlError:this._estadoCarga.error?this._estadoCarga.error:null}},{key:"estado",get:function(){return this.urlError?{error:this.urlError}:JSON.parse(JSON.stringify(this._estadoCarga))}}]),e}();t["default"]=s},function(e,t){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){return n(this,e),null}return r(e,null,[{key:"navegadorEsFirefox",value:function(){return window.navigator.userAgent.includes("Firefox")}}]),e}();t["default"]=o}]);